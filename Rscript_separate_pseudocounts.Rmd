---
title: "Untitled"
output: html_document
date: "2023-08-28"
---
---
title: "Rscript_RNAseq_analysis_per_cell_type"
output: html_document
date: "2023-03-06"
author: "Kelly"
update: "2023-08-08"
updated by: "Carli"
  chunk_output_type: console
---
If necessary, download the required libraries
```{r}
if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install(version = "3.16")

BiocManager::install("DESeq2")
BiocManager::install("tidyverse")
BiocManager::install("ggrepel")
install.packages("ggplot2")
install.packages("ggfortify")
BiocManager::install("RColorBrewer")
BiocManager::install("pheatmap")
install.packages("reshape")
BiocManager::install("PCAtools")
BiocManager::install("apeglm")
BiocManager::install("annotables")
```

Load the libraries
```{r}
library("DESeq2") #install Bioc::Manager and then DESeq2
library("ggplot2")
library("ggrepel")
library("EnhancedVolcano") #install BioC::Manager and then EnhancedVolcano
library("RColorBrewer")
library("pheatmap")
library("apeglm")

library("edgeR") #install BioC::Manager and then edgeR
library("tidyverse")
library("ggfortify")
library("reshape")
```

Load the metadata and rawcount.csv file
```{r}
RNA_project <- readline(prompt="Project code: ") #enter projectcode until second dash
Cell1_name <- readline(prompt="Name cell type 1: ")
Cell2_name <- readline(prompt="Name cell type 2: ")

metadata_Cell1 <- read.csv(file.path("analyse", paste0("Metadata", Cell1_name, ".csv")), row.names = 1)
metadata_Cell2 <- read.csv(file.path("analyse", paste0("Metadata", Cell2_name, ".csv")), row.names = 1)

counts_Cell1 <- read.csv(file.path("analyse", paste0("Rawcounts", Cell1_name, ".csv")), row.names = 1)
counts_Cell2 <- read.csv(file.path("analyse", paste0("Rawcounts", Cell2_name, ".csv")), row.names = 1)
```

Check if order of samples is the same in metadata and count table
```{r}
all(rownames(metadata_Cell1) == colnames(counts_Cell1))
all(rownames(metadata_Cell2) == colnames(counts_Cell2))
```

Create DESEq2 object
```{r}
dds_Cell2 <- DESeqDataSetFromMatrix(countData = counts_Cell2, 
                                    colData = metadata_Cell2, 
                                    design = ~ 1) 

# Run DESeq analysis
dds <- DESeq(dds_Cell2)

# Extract log2 fold change values for each sample
fold_changes <- as.data.frame(results(dds))
fold_changes$sample <- rownames(fold_changes)

selected_genes <- readLines("analyse/selected_genes.csv")

# Subset fold_changes to selected genes
selected_fold_changes <- fold_changes[selected_genes, ]

# Create a ggplot for the fold change values of selected genes
ggplot(selected_fold_changes, aes(x = selected_genes, y = log2FoldChange)) +
  geom_bar(stat = "identity", fill = "steelblue", width = 0.5) +
  geom_point(position = position_jitter(width = 0.2), color = "red") +  # Individual data points
  labs(x = "Gene", y = "Log2 Fold Change") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r}

# Calculate fold changes per N value
batches <- unique(metadata_Cell2$batch)

library(dplyr)

fold_changes_per_n <- lapply(batches, function(n) {
  n_genes <- subset(metadata_Cell2, batch == n)$gene
  fold_changes_subset <- fold_changes %>%
    filter(rownames(.) %in% n_genes) %>%
    summarise(log2FoldChange = mean(log2FoldChange))  # Calculate mean fold change
  fold_changes_subset$batch <- n
  rownames(fold_changes_subset) <- n_genes  # Set gene names as row names
  fold_changes_subset
})

# Combine fold changes for all N values
combined_fold_changes <- do.call(rbind, fold_changes_per_n)

# Filter out rows with missing values
filtered_fold_changes <- combined_fold_changes %>%
  drop_na(log2FoldChange, batch)

# Create a ggplot for fold changes per batch
ggplot(filtered_fold_changes, aes(x = batch, y = log2FoldChange, group = rownames(filtered_fold_changes))) +
  geom_point() +
  geom_line(aes(group = NULL), color = "blue") +
  labs(x = "Batch", y = "Mean Log2 Fold Change") +
  theme_minimal()
```

```{r}

library(DESeq2)
library(ggplot2)

# Assuming you have loaded raw counts and metadata into counts_Cell2 and metadata_Cell2

# Convert raw counts to DESeqDataSet
dds <- DESeqDataSetFromMatrix(countData = counts_Cell2,
                              colData = metadata_Cell2,
                              design = ~ batch + condition)

# List of batches
batches <- unique(metadata_Cell2$batch)

# Calculate log fold changes and create separate visualizations for each batch
for (batch in batches) {
  # Subset the data for the current batch
  subset_dds <- dds[dds$batch == batch, ]
  
  # Perform DESeq2 analysis
  dds_subset <- DESeq(subset_dds)
  
  # Extract log fold changes
  fold_changes <- results(dds_subset)
  
  # Convert DESeq2 result object to a data frame
  fold_changes_df <- as.data.frame(fold_changes)
  
# Filter fold_changes_df to include only selected genes
fold_changes_selected <- fold_changes_df[rownames(fold_changes_df) %in% selected_genes, ]
  
  # Create a ggplot for log fold changes
  p <- ggplot(fold_changes_selected, aes(x = baseMean, y = log2FoldChange)) +
    geom_point() +
    geom_hline(yintercept = 0, linetype = "dashed", color = "blue") +
    labs(x = "Base Mean", y = "Log2 Fold Change") +
    ggtitle(paste("Batch:", batch)) +
    theme_minimal()
  
  print(p)
}

```